"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Game = void 0;

var _helpers = require("./helpers/helpers");

var _interfaces = require("./interfaces/interfaces");

var _Food = require("./objects/Food");

var _Snake = require("./objects/Snake");

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var Game = //frame settings
//contollers
// game objects
//settings
function Game(moveRange) {
  var _this = this;

  _classCallCheck(this, Game);

  _defineProperty(this, "canvas", void 0);

  _defineProperty(this, "context", void 0);

  _defineProperty(this, "scoreboardHTML", void 0);

  _defineProperty(this, "stop", false);

  _defineProperty(this, "frameCount", 0);

  _defineProperty(this, "fps", void 0);

  _defineProperty(this, "now", void 0);

  _defineProperty(this, "fpsInterval", void 0);

  _defineProperty(this, "startTime", void 0);

  _defineProperty(this, "then", void 0);

  _defineProperty(this, "elapsed", void 0);

  _defineProperty(this, "direction", _interfaces.Direction.Down);

  _defineProperty(this, "pressedKeys", []);

  _defineProperty(this, "snake", void 0);

  _defineProperty(this, "food", void 0);

  _defineProperty(this, "score", 0);

  _defineProperty(this, "moveRange", void 0);

  _defineProperty(this, "startAnimating", function (fps) {
    _this.fpsInterval = 1000 / fps;
    _this.then = Date.now();
    _this.startTime = _this.then;

    _this.animate();
  });

  _defineProperty(this, "animate", function () {
    if (_this.stop) {
      return;
    }

    requestAnimationFrame(_this.animate);
    _this.now = Date.now();
    _this.elapsed = _this.now - _this.then;

    if (_this.elapsed > _this.fpsInterval) {
      _this.context.clearRect(0, 0, _this.canvas.width, _this.canvas.height);

      _this.then = _this.now - _this.elapsed % _this.fpsInterval;

      _this.setDirection();

      _this.snake.recalculateSegments(_this.direction);

      if (_this.snake.detectedFood(_this.food)) {
        _this.snake.addSegment(_this.direction);

        _this.food.generateApple(_this.snake, _this.canvas, _this.moveRange);

        _this.score++;

        _this.showScore();
      }

      if (_this.snake.detectCollisions(_this.canvas)) _this.start(); // this.setDirection();

      _this.redraw();
    }
  });

  _defineProperty(this, "start", function () {
    _this.score = 0;
    _this.snake = new _Snake.Snake({
      x: (0, _helpers.generatePosition)(_this.moveRange, 0, _this.canvas.width),
      y: (0, _helpers.generatePosition)(_this.moveRange, 0, _this.canvas.height)
    }, _this.moveRange);
    _this.food = new _Food.Food(_this.moveRange);

    _this.food.generateApple(_this.snake, _this.canvas, _this.moveRange);

    _this.showScore();
  });

  _defineProperty(this, "redraw", function () {
    //background
    for (var i = 0; i < _this.canvas.width; i += _this.moveRange) {
      for (var j = 0; j < _this.canvas.height; j += _this.moveRange) {
        _this.context.beginPath();

        _this.context.lineWidth = 0.5;
        _this.context.strokeStyle = "#fff";

        _this.context.rect(i, j, _this.moveRange, _this.moveRange);

        _this.context.stroke();
      }
    } //food


    _this.context.beginPath();

    _this.context.fillStyle = _this.food.segment.color;

    _this.context.fillRect(_this.food.segment.position.x, _this.food.segment.position.y, _this.food.segment.width, _this.food.segment.height); //snake


    var segments = _this.snake.getSegments();

    for (var _i = segments.length - 1; _i >= 0; _i--) {
      _this.context.beginPath();

      _this.context.fillStyle = segments[_i].color;

      _this.context.fillRect(segments[_i].position.x, segments[_i].position.y, segments[_i].width, segments[_i].height);
    }
  });

  _defineProperty(this, "createUserEvents", function () {
    window.addEventListener("keydown", _this.pressKeyEventHandler); // window.addEventListener("keyup", this.releaseKeyEventHanlde);
  });

  _defineProperty(this, "pressKeyEventHandler", function (e) {
    _this.pressedKeys = [];
    var key = e.key.toLowerCase();

    var find = _this.pressedKeys.indexOf(key);

    if (find <= -1) _this.pressedKeys.push(key);
  });

  _defineProperty(this, "setDirection", function () {
    if (_this.pressedKeys.length !== 1) return;
    if (_this.pressedKeys[0] === "w" && _this.direction != _interfaces.Direction.Down) _this.direction = _interfaces.Direction.Up;else if (_this.pressedKeys[0] === "s" && _this.direction != _interfaces.Direction.Up) _this.direction = _interfaces.Direction.Down;else if (_this.pressedKeys[0] === "a" && _this.direction != _interfaces.Direction.Right) _this.direction = _interfaces.Direction.Left;else if (_this.pressedKeys[0] === "d" && _this.direction != _interfaces.Direction.Left) _this.direction = _interfaces.Direction.Right;
  });

  _defineProperty(this, "showScore", function () {
    var scoreboard = _this.scoreboardHTML;
    var result = scoreboard.getElementsByClassName("result")[0];
    result.innerHTML = _this.score.toString();
  });

  var canvas = document.getElementById("canvas");
  var context = canvas.getContext("2d");
  var scoreboardHTML = document.getElementById("scoreboard");
  canvas.width = moveRange * 25;
  canvas.height = moveRange * 25;
  this.canvas = canvas;
  this.context = context;
  this.scoreboardHTML = scoreboardHTML;
  this.moveRange = moveRange;
  this.createUserEvents();
  this.start();
  this.startAnimating(10);
};

exports.Game = Game;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9HYW1lLnRzIl0sIm5hbWVzIjpbIkdhbWUiLCJtb3ZlUmFuZ2UiLCJEaXJlY3Rpb24iLCJEb3duIiwiZnBzIiwiZnBzSW50ZXJ2YWwiLCJ0aGVuIiwiRGF0ZSIsIm5vdyIsInN0YXJ0VGltZSIsImFuaW1hdGUiLCJzdG9wIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwiZWxhcHNlZCIsImNvbnRleHQiLCJjbGVhclJlY3QiLCJjYW52YXMiLCJ3aWR0aCIsImhlaWdodCIsInNldERpcmVjdGlvbiIsInNuYWtlIiwicmVjYWxjdWxhdGVTZWdtZW50cyIsImRpcmVjdGlvbiIsImRldGVjdGVkRm9vZCIsImZvb2QiLCJhZGRTZWdtZW50IiwiZ2VuZXJhdGVBcHBsZSIsInNjb3JlIiwic2hvd1Njb3JlIiwiZGV0ZWN0Q29sbGlzaW9ucyIsInN0YXJ0IiwicmVkcmF3IiwiU25ha2UiLCJ4IiwieSIsIkZvb2QiLCJpIiwiaiIsImJlZ2luUGF0aCIsImxpbmVXaWR0aCIsInN0cm9rZVN0eWxlIiwicmVjdCIsInN0cm9rZSIsImZpbGxTdHlsZSIsInNlZ21lbnQiLCJjb2xvciIsImZpbGxSZWN0IiwicG9zaXRpb24iLCJzZWdtZW50cyIsImdldFNlZ21lbnRzIiwibGVuZ3RoIiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsInByZXNzS2V5RXZlbnRIYW5kbGVyIiwiZSIsInByZXNzZWRLZXlzIiwia2V5IiwidG9Mb3dlckNhc2UiLCJmaW5kIiwiaW5kZXhPZiIsInB1c2giLCJVcCIsIlJpZ2h0IiwiTGVmdCIsInNjb3JlYm9hcmQiLCJzY29yZWJvYXJkSFRNTCIsInJlc3VsdCIsImdldEVsZW1lbnRzQnlDbGFzc05hbWUiLCJpbm5lckhUTUwiLCJ0b1N0cmluZyIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJnZXRDb250ZXh0IiwiY3JlYXRlVXNlckV2ZW50cyIsInN0YXJ0QW5pbWF0aW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FB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LElBQStCLEtBQUksQ0FBQ2pDLFNBQUwsSUFBa0JwQixzQkFBVTZELElBQS9ELEVBQ0gsS0FBSSxDQUFDekMsU0FBTCxHQUFpQnBCLHNCQUFVNEQsS0FBM0I7QUFDSCxHQW5JOEI7O0FBQUEscUNBcUlYLFlBQVk7QUFDOUIsUUFBSUUsVUFBVSxHQUFHLEtBQUksQ0FBQ0MsY0FBdEI7QUFFQSxRQUFJQyxNQUFNLEdBQUdGLFVBQVUsQ0FBQ0csc0JBQVgsQ0FBa0MsUUFBbEMsRUFBNEMsQ0FBNUMsQ0FBYjtBQUNBRCxJQUFBQSxNQUFNLENBQUNFLFNBQVAsR0FBbUIsS0FBSSxDQUFDekMsS0FBTCxDQUFXMEMsUUFBWCxFQUFuQjtBQUNELEdBMUk4Qjs7QUFDN0IsTUFBSXJELE1BQU0sR0FBR3NELFFBQVEsQ0FBQ0MsY0FBVCxDQUF3QixRQUF4QixDQUFiO0FBQ0EsTUFBSXpELE9BQU8sR0FBR0UsTUFBTSxDQUFDd0QsVUFBUCxDQUFrQixJQUFsQixDQUFkO0FBQ0EsTUFBSVAsY0FBYyxHQUFHSyxRQUFRLENBQUNDLGNBQVQsQ0FDbkIsWUFEbUIsQ0FBckI7QUFJQXZELEVBQUFBLE1BQU0sQ0FBQ0MsS0FBUCxHQUFlaEIsU0FBUyxHQUFHLEVBQTNCO0FBQ0FlLEVBQUFBLE1BQU0sQ0FBQ0UsTUFBUCxHQUFnQmpCLFNBQVMsR0FBRyxFQUE1QjtBQUVBLE9BQUtlLE1BQUwsR0FBY0EsTUFBZDtBQUNBLE9BQUtGLE9BQUwsR0FBZUEsT0FBZjtBQUNBLE9BQUttRCxjQUFMLEdBQXNCQSxjQUF0QjtBQUVBLE9BQUtoRSxTQUFMLEdBQWlCQSxTQUFqQjtBQUNBLE9BQUt3RSxnQkFBTDtBQUNBLE9BQUszQyxLQUFMO0FBQ0EsT0FBSzRDLGNBQUwsQ0FBb0IsRUFBcEI7QUFDRCxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2VuZXJhdGVQb3NpdGlvbiB9IGZyb20gXCIuL2hlbHBlcnMvaGVscGVyc1wiO1xyXG5pbXBvcnQgeyBEaXJlY3Rpb24sIElQb3NpdGlvbiB9IGZyb20gXCIuL2ludGVyZmFjZXMvaW50ZXJmYWNlc1wiO1xyXG5pbXBvcnQgeyBGb29kIH0gZnJvbSBcIi4vb2JqZWN0cy9Gb29kXCI7XHJcbmltcG9ydCB7IFNuYWtlIH0gZnJvbSBcIi4vb2JqZWN0cy9TbmFrZVwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEdhbWUge1xyXG4gIHByaXZhdGUgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudDtcclxuICBwcml2YXRlIGNvbnRleHQ6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcclxuICBwcml2YXRlIHNjb3JlYm9hcmRIVE1MOiBIVE1MRGl2RWxlbWVudDtcclxuXHJcbiAgLy9mcmFtZSBzZXR0aW5nc1xyXG4gIHByaXZhdGUgc3RvcCA9IGZhbHNlO1xyXG4gIHByaXZhdGUgZnJhbWVDb3VudDogbnVtYmVyID0gMDtcclxuICBwcml2YXRlIGZwczogbnVtYmVyO1xyXG4gIHByaXZhdGUgbm93OiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBmcHNJbnRlcnZhbDogbnVtYmVyO1xyXG4gIHByaXZhdGUgc3RhcnRUaW1lOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSB0aGVuOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBlbGFwc2VkOiBudW1iZXI7XHJcblxyXG4gIC8vY29udG9sbGVyc1xyXG4gIHByaXZhdGUgZGlyZWN0aW9uOiBEaXJlY3Rpb24gPSBEaXJlY3Rpb24uRG93bjtcclxuICBwcml2YXRlIHByZXNzZWRLZXlzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAvLyBnYW1lIG9iamVjdHNcclxuICBwcml2YXRlIHNuYWtlOiBTbmFrZTtcclxuICBwcml2YXRlIGZvb2Q6IEZvb2Q7XHJcbiAgcHJpdmF0ZSBzY29yZSA9IDA7XHJcblxyXG4gIC8vc2V0dGluZ3NcclxuICBwcml2YXRlIG1vdmVSYW5nZTogbnVtYmVyO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihtb3ZlUmFuZ2U6IG51bWJlcikge1xyXG4gICAgbGV0IGNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiY2FudmFzXCIpIGFzIEhUTUxDYW52YXNFbGVtZW50O1xyXG4gICAgbGV0IGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dChcIjJkXCIpO1xyXG4gICAgbGV0IHNjb3JlYm9hcmRIVE1MID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXHJcbiAgICAgIFwic2NvcmVib2FyZFwiXHJcbiAgICApIGFzIEhUTUxEaXZFbGVtZW50O1xyXG5cclxuICAgIGNhbnZhcy53aWR0aCA9IG1vdmVSYW5nZSAqIDI1O1xyXG4gICAgY2FudmFzLmhlaWdodCA9IG1vdmVSYW5nZSAqIDI1O1xyXG5cclxuICAgIHRoaXMuY2FudmFzID0gY2FudmFzO1xyXG4gICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDtcclxuICAgIHRoaXMuc2NvcmVib2FyZEhUTUwgPSBzY29yZWJvYXJkSFRNTDtcclxuXHJcbiAgICB0aGlzLm1vdmVSYW5nZSA9IG1vdmVSYW5nZTtcclxuICAgIHRoaXMuY3JlYXRlVXNlckV2ZW50cygpO1xyXG4gICAgdGhpcy5zdGFydCgpO1xyXG4gICAgdGhpcy5zdGFydEFuaW1hdGluZygxMCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHN0YXJ0QW5pbWF0aW5nID0gKGZwczogbnVtYmVyKSA9PiB7XHJcbiAgICB0aGlzLmZwc0ludGVydmFsID0gMTAwMCAvIGZwcztcclxuICAgIHRoaXMudGhlbiA9IERhdGUubm93KCk7XHJcbiAgICB0aGlzLnN0YXJ0VGltZSA9IHRoaXMudGhlbjtcclxuICAgIHRoaXMuYW5pbWF0ZSgpO1xyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgYW5pbWF0ZSA9ICgpID0+IHtcclxuICAgIGlmICh0aGlzLnN0b3ApIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLmFuaW1hdGUpO1xyXG5cclxuICAgIHRoaXMubm93ID0gRGF0ZS5ub3coKTtcclxuICAgIHRoaXMuZWxhcHNlZCA9IHRoaXMubm93IC0gdGhpcy50aGVuO1xyXG5cclxuICAgIGlmICh0aGlzLmVsYXBzZWQgPiB0aGlzLmZwc0ludGVydmFsKSB7XHJcbiAgICAgIHRoaXMuY29udGV4dC5jbGVhclJlY3QoMCwgMCwgdGhpcy5jYW52YXMud2lkdGgsIHRoaXMuY2FudmFzLmhlaWdodCk7XHJcbiAgICAgIHRoaXMudGhlbiA9IHRoaXMubm93IC0gKHRoaXMuZWxhcHNlZCAlIHRoaXMuZnBzSW50ZXJ2YWwpO1xyXG5cclxuICAgICAgdGhpcy5zZXREaXJlY3Rpb24oKTtcclxuICAgICAgdGhpcy5zbmFrZS5yZWNhbGN1bGF0ZVNlZ21lbnRzKHRoaXMuZGlyZWN0aW9uKTtcclxuXHJcbiAgICAgIGlmICh0aGlzLnNuYWtlLmRldGVjdGVkRm9vZCh0aGlzLmZvb2QpKSB7XHJcbiAgICAgICAgdGhpcy5zbmFrZS5hZGRTZWdtZW50KHRoaXMuZGlyZWN0aW9uKTtcclxuICAgICAgICB0aGlzLmZvb2QuZ2VuZXJhdGVBcHBsZSh0aGlzLnNuYWtlLCB0aGlzLmNhbnZhcywgdGhpcy5tb3ZlUmFuZ2UpO1xyXG4gICAgICAgIHRoaXMuc2NvcmUrKztcclxuICAgICAgICB0aGlzLnNob3dTY29yZSgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAodGhpcy5zbmFrZS5kZXRlY3RDb2xsaXNpb25zKHRoaXMuY2FudmFzKSkgdGhpcy5zdGFydCgpO1xyXG4gICAgICAvLyB0aGlzLnNldERpcmVjdGlvbigpO1xyXG4gICAgICB0aGlzLnJlZHJhdygpO1xyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgc3RhcnQgPSAoKSA9PiB7XHJcbiAgICB0aGlzLnNjb3JlID0gMDtcclxuICAgIHRoaXMuc25ha2UgPSBuZXcgU25ha2UoXHJcbiAgICAgIHtcclxuICAgICAgICB4OiBnZW5lcmF0ZVBvc2l0aW9uKHRoaXMubW92ZVJhbmdlLCAwLCB0aGlzLmNhbnZhcy53aWR0aCksXHJcbiAgICAgICAgeTogZ2VuZXJhdGVQb3NpdGlvbih0aGlzLm1vdmVSYW5nZSwgMCwgdGhpcy5jYW52YXMuaGVpZ2h0KSxcclxuICAgICAgfSBhcyBJUG9zaXRpb24sXHJcbiAgICAgIHRoaXMubW92ZVJhbmdlXHJcbiAgICApO1xyXG4gICAgdGhpcy5mb29kID0gbmV3IEZvb2QodGhpcy5tb3ZlUmFuZ2UpO1xyXG4gICAgdGhpcy5mb29kLmdlbmVyYXRlQXBwbGUodGhpcy5zbmFrZSwgdGhpcy5jYW52YXMsIHRoaXMubW92ZVJhbmdlKTtcclxuICAgIHRoaXMuc2hvd1Njb3JlKCk7XHJcbiAgfTtcclxuXHJcbiAgcHJpdmF0ZSByZWRyYXcgPSAoKSA9PiB7XHJcbiAgICAvL2JhY2tncm91bmRcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jYW52YXMud2lkdGg7IGkgKz0gdGhpcy5tb3ZlUmFuZ2UpIHtcclxuICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0aGlzLmNhbnZhcy5oZWlnaHQ7IGogKz0gdGhpcy5tb3ZlUmFuZ2UpIHtcclxuICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7XHJcbiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVXaWR0aCA9IDAuNTtcclxuICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBcIiNmZmZcIjtcclxuICAgICAgICB0aGlzLmNvbnRleHQucmVjdChpLCBqLCB0aGlzLm1vdmVSYW5nZSwgdGhpcy5tb3ZlUmFuZ2UpO1xyXG4gICAgICAgIHRoaXMuY29udGV4dC5zdHJva2UoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vZm9vZFxyXG4gICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpO1xyXG4gICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IHRoaXMuZm9vZC5zZWdtZW50LmNvbG9yO1xyXG4gICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KFxyXG4gICAgICB0aGlzLmZvb2Quc2VnbWVudC5wb3NpdGlvbi54LFxyXG4gICAgICB0aGlzLmZvb2Quc2VnbWVudC5wb3NpdGlvbi55LFxyXG4gICAgICB0aGlzLmZvb2Quc2VnbWVudC53aWR0aCxcclxuICAgICAgdGhpcy5mb29kLnNlZ21lbnQuaGVpZ2h0XHJcbiAgICApO1xyXG5cclxuICAgIC8vc25ha2VcclxuICAgIGxldCBzZWdtZW50cyA9IHRoaXMuc25ha2UuZ2V0U2VnbWVudHMoKTtcclxuICAgIGZvciAobGV0IGkgPSBzZWdtZW50cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xyXG4gICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7XHJcbiAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBzZWdtZW50c1tpXS5jb2xvcjtcclxuICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KFxyXG4gICAgICAgIHNlZ21lbnRzW2ldLnBvc2l0aW9uLngsXHJcbiAgICAgICAgc2VnbWVudHNbaV0ucG9zaXRpb24ueSxcclxuICAgICAgICBzZWdtZW50c1tpXS53aWR0aCxcclxuICAgICAgICBzZWdtZW50c1tpXS5oZWlnaHRcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICAvL2V2ZW50c1xyXG4gIHByaXZhdGUgY3JlYXRlVXNlckV2ZW50cyA9ICgpID0+IHtcclxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwia2V5ZG93blwiLCB0aGlzLnByZXNzS2V5RXZlbnRIYW5kbGVyKTtcclxuICAgIC8vIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwia2V5dXBcIiwgdGhpcy5yZWxlYXNlS2V5RXZlbnRIYW5sZGUpO1xyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgcHJlc3NLZXlFdmVudEhhbmRsZXIgPSAoZTogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gICAgdGhpcy5wcmVzc2VkS2V5cyA9IFtdO1xyXG4gICAgY29uc3Qga2V5ID0gZS5rZXkudG9Mb3dlckNhc2UoKTtcclxuXHJcbiAgICBjb25zdCBmaW5kID0gdGhpcy5wcmVzc2VkS2V5cy5pbmRleE9mKGtleSk7XHJcbiAgICBpZiAoZmluZCA8PSAtMSkgdGhpcy5wcmVzc2VkS2V5cy5wdXNoKGtleSk7XHJcbiAgfTtcclxuICBwcml2YXRlIHNldERpcmVjdGlvbiA9ICgpOiB2b2lkID0+IHtcclxuICAgIGlmICh0aGlzLnByZXNzZWRLZXlzLmxlbmd0aCAhPT0gMSkgcmV0dXJuO1xyXG5cclxuICAgIGlmICh0aGlzLnByZXNzZWRLZXlzWzBdID09PSBcIndcIiAmJiB0aGlzLmRpcmVjdGlvbiAhPSBEaXJlY3Rpb24uRG93bilcclxuICAgICAgdGhpcy5kaXJlY3Rpb24gPSBEaXJlY3Rpb24uVXA7XHJcbiAgICBlbHNlIGlmICh0aGlzLnByZXNzZWRLZXlzWzBdID09PSBcInNcIiAmJiB0aGlzLmRpcmVjdGlvbiAhPSBEaXJlY3Rpb24uVXApXHJcbiAgICAgIHRoaXMuZGlyZWN0aW9uID0gRGlyZWN0aW9uLkRvd247XHJcbiAgICBlbHNlIGlmICh0aGlzLnByZXNzZWRLZXlzWzBdID09PSBcImFcIiAmJiB0aGlzLmRpcmVjdGlvbiAhPSBEaXJlY3Rpb24uUmlnaHQpXHJcbiAgICAgIHRoaXMuZGlyZWN0aW9uID0gRGlyZWN0aW9uLkxlZnQ7XHJcbiAgICBlbHNlIGlmICh0aGlzLnByZXNzZWRLZXlzWzBdID09PSBcImRcIiAmJiB0aGlzLmRpcmVjdGlvbiAhPSBEaXJlY3Rpb24uTGVmdClcclxuICAgICAgdGhpcy5kaXJlY3Rpb24gPSBEaXJlY3Rpb24uUmlnaHQ7XHJcbiAgfTtcclxuXHJcbiAgcHJpdmF0ZSBzaG93U2NvcmUgPSAoKTogdm9pZCA9PiB7XHJcbiAgICBsZXQgc2NvcmVib2FyZCA9IHRoaXMuc2NvcmVib2FyZEhUTUw7XHJcblxyXG4gICAgbGV0IHJlc3VsdCA9IHNjb3JlYm9hcmQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcInJlc3VsdFwiKVswXTtcclxuICAgIHJlc3VsdC5pbm5lckhUTUwgPSB0aGlzLnNjb3JlLnRvU3RyaW5nKCk7XHJcbiAgfTtcclxufVxyXG4iXX0=